# üîê –ú–æ–¥–µ—Ä–∞—Ü–∏—è –∏ –ö–æ–Ω—Ç—Ä–æ–ª—å –î–æ—Å—Ç—É–ø–∞

## –ù–æ–≤—ã–µ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. –õ–∏–º–∏—Ç –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è Events
- –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–∫–∞–∑–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –ª–∏–º–∏—Ç –¥–æ—Å—Ç–∏–≥–Ω—É—Ç
- –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ

### 2. –ú–æ–¥–µ—Ä–∞—Ü–∏—è –í—Å—Ç—É–ø–ª–µ–Ω–∏—è –≤ Events
- –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∏—Ç—å —Ä—É—á–Ω–æ–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ (—Å—Ç–∞—Ç—É—Å `PENDING`)
- –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –≤–∏–¥–∏—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –º–æ–∂–µ—Ç –æ–¥–æ–±—Ä–∏—Ç—å –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å
- –ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫ –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —á–∞—Ç—É —Ç–æ–ø–∏–∫–∞

### 3. –ö–æ–Ω—Ç—Ä–æ–ª—å –õ–∏—á–Ω—ã—Ö –°–æ–æ–±—â–µ–Ω–∏–π
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –ø–æ–ª—É—á–∞—Ç—å –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ –ø—Ä–æ—Ñ–∏–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`allow_direct_messages`)
- –ï—Å–ª–∏ –∑–∞–ø—Ä–µ—â–µ–Ω–æ - –∫–Ω–æ–ø–∫–∞ "–ù–∞–ø–∏—Å–∞—Ç—å" –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞

## –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ú–∏–≥—Ä–∞—Ü–∏–∏

### –®–∞–≥ 1: –û—Ç–∫—Ä–æ–π—Ç–µ Supabase SQL Editor
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ [https://supabase.com/dashboard](https://supabase.com/dashboard)
2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç
3. –û—Ç–∫—Ä–æ–π—Ç–µ **SQL Editor** –≤ –±–æ–∫–æ–≤–æ–º –º–µ–Ω—é

### –®–∞–≥ 2: –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç
1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ `supabase/migrations/002_add_moderation_features.sql`
2. –í—Å—Ç–∞–≤—å—Ç–µ –≤ SQL Editor
3. –ù–∞–∂–º–∏—Ç–µ **Run** (–∏–ª–∏ Ctrl/Cmd + Enter)

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
–í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ –≤ items
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'items' 
AND column_name IN ('max_participants', 'requires_approval', 'current_participants');

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã chat_participants
SELECT * FROM information_schema.tables WHERE table_name = 'chat_participants';

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ is_event_full
SELECT routine_name FROM information_schema.routines WHERE routine_name = 'is_event_full';
```

–ï—Å–ª–∏ –≤—Å–µ 3 –∑–∞–ø—Ä–æ—Å–∞ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã - –º–∏–≥—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞! ‚úÖ

## –ù–æ–≤—ã–µ API Endpoints

### 1. **POST /api/items/[id]/join**
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ—Ç—Å—è –∫ Event –∏–ª–∏ –æ—Ç–∫–ª–∏–∫–∞–µ—Ç—Å—è –Ω–∞ Task

**Request Body:**
```json
{
  "userId": "123456789",
  "message": "I want to join!" // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è Tasks
}
```

**Response:**
```json
{
  "success": true,
  "participant": {
    "id": "uuid",
    "item_id": "uuid",
    "user_id": "123456789",
    "status": "PENDING" // –∏–ª–∏ "APPROVED" –µ—Å–ª–∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –º–æ–¥–µ—Ä–∞—Ü–∏—è
  },
  "requiresApproval": true,
  "message": "Join request sent. Waiting for approval."
}
```

### 2. **GET /api/items/[id]/join?status=PENDING**
–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ (–¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞)

**Query Params:**
- `status` (optional): `PENDING`, `APPROVED`, `REJECTED`, `LEFT`

**Response:**
```json
{
  "participants": [
    {
      "id": "uuid",
      "item_id": "uuid",
      "user_id": "123456789",
      "status": "PENDING",
      "joined_at": "2025-01-28T12:00:00Z",
      "user": {
        "id": "123456789",
        "first_name": "John",
        "last_name": "Doe",
        "avatar_url": "https://...",
        "reputation": 4.8
      }
    }
  ]
}
```

### 3. **PATCH /api/items/[id]/join/[participantId]**
–û–¥–æ–±—Ä–∏—Ç—å –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ

**Request Body:**
```json
{
  "status": "APPROVED", // –∏–ª–∏ "REJECTED"
  "authorId": "987654321" // ID –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞
}
```

**Response:**
```json
{
  "success": true,
  "participant": { /* updated participant */ },
  "message": "Participant approved!"
}
```

### 4. **DELETE /api/items/[id]/join/[participantId]?userId=123**
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∏–¥–∞–µ—Ç Event –∏–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –≤—ã–≥–æ–Ω—è–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–∞

## UI Components

### CreateDrawer
–ù–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è Events:

```tsx
// Max Participants (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
<input 
  type="number"
  min="2"
  placeholder="Unlimited"
  value={formData.maxParticipants}
  onChange={(e) => setFormData({ maxParticipants: e.target.value })}
/>

// Requires Approval Toggle
<Toggle 
  checked={formData.requiresApproval}
  onChange={(val) => setFormData({ requiresApproval: val })}
/>
```

### ItemDrawer
–î–ª—è Events —Å –º–æ–¥–µ—Ä–∞—Ü–∏–µ–π –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å:

```tsx
{item.requires_approval ? (
  <SlideButton text="Request to Join" />
) : (
  <SlideButton text="Join Event" />
)}
```

–î–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤–∫–ª–∞–¥–∫—É "Join Requests":

```tsx
{isOwner && item.type === 'EVENT' && (
  <Tab name="join-requests">
    {pendingParticipants.map(p => (
      <ParticipantCard 
        participant={p}
        onApprove={() => approveParticipant(p.id)}
        onReject={() => rejectParticipant(p.id)}
      />
    ))}
  </Tab>
)}
```

## –ü—Ä–∏–º–µ—Ä—ã –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°–æ–∑–¥–∞–Ω–∏–µ Event —Å –õ–∏–º–∏—Ç–æ–º
```typescript
const eventData = {
  type: 'EVENT',
  title: '–§—É—Ç–±–æ–ª –Ω–∞ —Ä–∞–π–æ–Ω–µ',
  description: '–ò–≥—Ä–∞–µ–º –≤ —Ñ—É—Ç–±–æ–ª',
  max_participants: 10, // –ú–∞–∫—Å–∏–º—É–º 10 —á–µ–ª–æ–≤–µ–∫
  requires_approval: true, // –†—É—á–Ω–∞—è –º–æ–¥–µ—Ä–∞—Ü–∏—è
  ...
};

await createItem(eventData);
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ Event
```typescript
const { data: isFull } = await supabase
  .rpc('is_event_full', { event_id: 'uuid' });

if (isFull) {
  alert('Event is full!');
}
```

### –û–¥–æ–±—Ä–µ–Ω–∏–µ –£—á–∞—Å—Ç–Ω–∏–∫–∞
```typescript
const response = await fetch(`/api/items/${itemId}/join/${participantId}`, {
  method: 'PATCH',
  body: JSON.stringify({
    status: 'APPROVED',
    authorId: currentUser.id,
  }),
});
```

## –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö

### –ù–æ–≤–∞—è –¢–∞–±–ª–∏—Ü–∞: `chat_participants`

| Column | Type | Description |
|--------|------|-------------|
| id | UUID | Primary key |
| item_id | UUID | FK to items |
| user_id | BIGINT | FK to users |
| status | TEXT | PENDING, APPROVED, REJECTED, LEFT |
| joined_at | TIMESTAMPTZ | –í—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞ |
| approved_at | TIMESTAMPTZ | –í—Ä–µ–º—è –æ–¥–æ–±—Ä–µ–Ω–∏—è |
| approved_by | BIGINT | FK to users (–∫—Ç–æ –æ–¥–æ–±—Ä–∏–ª) |

### –ù–æ–≤—ã–µ –ö–æ–ª–æ–Ω–∫–∏ –≤ `items`

| Column | Type | Description |
|--------|------|-------------|
| max_participants | INTEGER | NULL = unlimited |
| requires_approval | BOOLEAN | Default: false |
| current_participants | INTEGER | Auto-updated by trigger |

### –ù–æ–≤—ã–µ –ö–æ–ª–æ–Ω–∫–∏ –≤ `users`

| Column | Type | Description |
|--------|------|-------------|
| allow_direct_messages | BOOLEAN | Default: true |
| auto_accept_responses | BOOLEAN | Default: true |

## Telegram Integration

### –°–æ–∑–¥–∞–Ω–∏–µ –¢–æ–ø–∏–∫–æ–≤
–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è item –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:

```typescript
POST /api/telegram/create-group
{
  "itemId": "uuid",
  "title": "–§—É—Ç–±–æ–ª –Ω–∞ —Ä–∞–π–æ–Ω–µ",
  "type": "EVENT"
}
```

–û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `items.telegram_topic_id` –∏ `items.telegram_chat_id`.

### –ú–æ–¥–µ—Ä–∞—Ü–∏—è –î–æ—Å—Ç—É–ø–∞ –∫ –¢–æ–ø–∏–∫—É
- –ï—Å–ª–∏ `requires_approval = true`, –Ω–æ–≤—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –Ω–µ –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –≤ —Ç–æ–ø–∏–∫ –ø–æ–∫–∞ –Ω–µ –æ–¥–æ–±—Ä–µ–Ω—ã
- –ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –±–æ—Ç –º–æ–∂–µ—Ç –¥–∞—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å (—á–µ—Ä–µ–∑ Telegram Bot API)

## Troubleshooting

### –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ Supabase
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø—Ä–µ–¥—ã–¥—É—â–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (`001_initial_schema.sql`) —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞

### –¢–æ–ø–∏–∫–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ `TELEGRAM_BOT_TOKEN` –∏ `TELEGRAM_CHAT_ID` –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ `.env.local`
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –±–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—É –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å –ø—Ä–∞–≤–∞–º–∏ `can_manage_topics`

### –û—à–∏–±–∫–∞ "Event is full"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ `max_participants` –≤ —Ç–∞–±–ª–∏—Ü–µ `items`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `APPROVED` –≤ `chat_participants`

## –î–∞–ª—å–Ω–µ–π—à–∏–µ –£–ª—É—á—à–µ–Ω–∏—è

- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Telegram –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞
- [ ] –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ Event
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ Event –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞
- [ ] Waitlist –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö Events
- [ ] –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –≤—ã—Å–æ–∫–∏–º reputation
